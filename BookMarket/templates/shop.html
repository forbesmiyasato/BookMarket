{% extends "layout.html" %}
{% block content %}
<!-- Start Banner Area -->
<section class="banner-area organic-breadcrumb">
    <div class="container">
        <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
            <div class="col-first">
                <h1>Shop page</h1>
                <nav class="d-flex align-items-center" id="banner-navigation">
                    <a href="{{url_for('home')}}">Home</a><span class="lnr lnr-arrow-right banner-arrow"></span>
                    <a href="{{url_for('shop_api.shop')}}">Shop</span>
                    </a>
                    <div id="nav-department"></div>
                    <div id="nav-course"></div>
                </nav>
            </div>
        </div>
    </div>
</section>
<!-- End Banner Area -->
<div class="container">
    <div class="row">
        {% include "side_bar.html" %}
        <div class="col-xl-9 col-lg-8 col-md-7" id="posts-section">
        </div>
    </div>
</div>
</div>

<!-- Start related-product Area -->
<section class="related-product-area section_gap">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6 text-center">
                <div class="section-title">
                    <h1>Deals of the Week</h1>
                    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut
                        labore et dolore
                        magna aliqua.</p>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    function getParameterByName(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }

    const getData = (url) => {
        console.log(url)
        $.ajax({
            url: url,
            type: "get",
            data: null,
            success: function (response) {
                console.log(response)
                let course = response.course
                let department = response.department
                if (course) {
                    $("#nav-department").html
                        ('<span class="lnr lnr-arrow-right banner-arrow"></span>' +
                            `<a href="javascript:getData('{{url_for('shop_api.getPosts')}}?department=${department.id}')">${department.name}</a>`);
                    $("#nav-course").html
                        ('<span class="lnr lnr-arrow-right banner-arrow"></span>' +
                            `<a class="text-white">${course.name}</a>`);
                } else if (department) {
                    $("#nav-department").html
                        ('<span class="lnr lnr-arrow-right banner-arrow"></span>' +
                            `<a class="text-white">${department.name}</a>`);
                    $("#nav-course").html('')

                } else {
                    $("#nav-department").html('')
                    $("#nav-course").html('')
                }
                $("#posts-section").html(response.html);
            },
            beforeSend: function () {
                $("#items-list").hide();
                $("#posts-spinner").show();
            },
            complete: function () {
                $("#posts-spinner").hide();
                $("#items-list").show();
            },
            error: function (xhr) {
                getAll() // return to main shop page on invalid query caused by user messing with url params
            }
        });
    }

    function insertBeforeLastOccurrence(strToSearch, strToFind, strToInsert) {
        var n = strToSearch.lastIndexOf(strToFind);
        if (n < 0) return strToSearch;
        return strToSearch.substring(0, n) + strToInsert + strToSearch.substring(n);
    }

    const show = (term) => {
        let url
        if (window.location.href.includes('?')) {
            url = new URL(insertBeforeLastOccurrence(window.location.href, "?", '/data'))
        } else {
            url = new URL(window.location.href + '/data')
        }
        let search_params = url.searchParams;

        if (term === 'all') {
            search_params.set('show', 'all')
        } else {
            search_params.delete('show')
        }

        url.search = search_params.toString();
        let params = url.toString().replace('/data', '');
        params = params.substring(params.lastIndexOf("/") + 1);
        history.pushState(null, '', params);
        console.log(url.toString());
        getData(url.toString());
    }

    const filterByPrice = (min, max) => {
        let url
        if (window.location.href.includes('?')) {
            url = new URL(insertBeforeLastOccurrence(window.location.href, "?", '/data'))
        } else {
            url = new URL(window.location.href + '/data')
        }
        let search_params = url.searchParams;

        search_params.set('filter', `${min}+${max}`)

        url.search = search_params.toString();
        let params = url.toString().replace('/data', '');
        params = params.substring(params.lastIndexOf("/") + 1);
        history.pushState(null, '', params);

        console.log(url.toString());
        getData(url.toString());
    }

    const getAll = () => {
        var url = window.location.href.split('?')[0] + '/data';

        history.replaceState(null, '', 'shop');

        getData(url)
    }

    const getFromPage = (page_num) => {
        let url
        if (window.location.href.includes('?')) {
            url = new URL(insertBeforeLastOccurrence(window.location.href, "?", '/data'))
        } else {
            url = new URL(window.location.href + '/data')
        }
        let search_params = url.searchParams;

        search_params.set('page', page_num)

        url.search = search_params.toString();
        let params = url.toString().replace('/data', '');
        params = params.substring(params.lastIndexOf("/") + 1);
        history.pushState(null, '', params);

        console.log(url.toString());
        getData(url.toString());
    }

    const filterByClass = (class_id, class_name, department_id, department_name) => {
        let url
        if (window.location.href.includes('?')) {
            url = new URL(insertBeforeLastOccurrence(window.location.href, "?", '/data'))
        } else {
            url = new URL(window.location.href + '/data')
        }
        let search_params = url.searchParams;

        search_params.set('class', class_id)
        search_params.delete('department')

        url.search = search_params.toString();

        history.pushState(null, '', `?class=${class_id}`);

        console.log(class_id, class_name, department_name, department_id)
        console.log(url.toString());
        getData(url.toString());
        // $("#nav-department").html
        //     ('<span class="lnr lnr-arrow-right banner-arrow"></span>' +
        //         `<a href="javascript:getData('{{url_for('shop_api.getPosts')}}?department=${department_id}')">${department_name}</a>`);
        // $("#nav-course").html
        //     ('<span class="lnr lnr-arrow-right banner-arrow"></span>' +
        //     `<a class="text-white">${class_name}</a>`);
    }

    const filterByDepartment = (department_id) => {
        let url
        if (window.location.href.includes('?')) {
            url = new URL(insertBeforeLastOccurrence(window.location.href, "?", '/data'))
        } else {
            url = new URL(window.location.href + '/data')
        }
        let search_params = url.searchParams;

        search_params.set('department', department_id)
        search_params.delete('class')
        url.search = search_params.toString();

        history.pushState(null, '', `?department=${department_id}`);

        console.log(url.toString());
        getData(url.toString());
    }

    const sort = (order) => {
        let url
        if (window.location.href.includes('?')) {
            url = new URL(insertBeforeLastOccurrence(window.location.href, "?", '/data'))
        } else {
            url = new URL(window.location.href + '/data')
        }
        let search_params = url.searchParams;

        search_params.set('sort', order)

        url.search = search_params.toString();
        let params = url.toString().replace('/data', '');
        params = params.substring(params.lastIndexOf("/") + 1);
        history.pushState(null, '', params);

        console.log(url.toString());
        getData(url.toString());
    }

    $('document').ready(function () {
        $("#posts-spinner").show();

        let url
        if (window.location.href.includes('?')) {
            url = new URL(insertBeforeLastOccurrence(window.location.href, "?", '/data'))
        } else {
            url = new URL(window.location.href + '/data')
        }

        console.log(url.toString());
        getData(url.toString());
    })
    // $('document').ready(function () {
    //     var persistedQueryParam = getParameterByName('per_page');

    //     if (persistedQueryParam && persistedQueryParam.length > 0) {
    //         $('a.persist-link').each(function () {
    //             var elem = $(this);
    //             var href = elem.attr('href');
    //             elem.attr('href', href + (href.indexOf('?') != -1 ? '&' : '?') + 'per_page=' + persistedQueryParam);
    //         });
    //     }

    //     var persistedQueryParam = getParameterByName('order');

    //     if (persistedQueryParam && persistedQueryParam.length > 0) {
    //         $('a.persist-link').each(function () {
    //             var elem = $(this);
    //             var href = elem.attr('href');
    //             elem.attr('href', href + (href.indexOf('?') != -1 ? '&' : '?') + 'order=' + persistedQueryParam);
    //         });
    //     }
    // });

    // document.addEventListener('DOMContentLoaded', function (event) {
    //     var options = document.getElementsByClassName('option');
    //     var a = document.createElement("a");
    //     //set date descending sort for front end
    //     a.textContent = "Newest to Oldest";
    //     var url = "{{url_for('shop_api.shop', order='desc', per_page=request.args.get('per_page'))}}".replace('&amp;', '&')
    //     options[0].innerHTML = "";
    //     a.setAttribute('href', url);
    //     a.setAttribute('style', 'color:rgb(119, 119, 119)')
    //     a.setAttribute('class', 'persist-link li-link')
    //     options[0].appendChild(a);

    //     //set date ascending sort for front end
    //     var b = document.createElement("a");
    //     b.textContent = options[1].innerHTML;
    //     options[1].innerHTML = "";
    //     var url = "{{url_for('shop_api.shop', order='asc', per_page=request.args.get('per_page'))}}".replace('&amp;', '&')
    //     b.setAttribute('href', url);
    //     b.setAttribute('style', 'color:rgb(119, 119, 119)')
    //     b.setAttribute('class', 'persist-link li-link')
    //     options[1].appendChild(b);

    //     //set date ascending sort for front end
    //     var b = document.createElement("a");
    //     b.textContent = options[2].innerHTML;
    //     options[2].innerHTML = "";
    //     var url = "{{url_for('shop_api.shop', order='asc', per_page=request.args.get('per_page'))}}".replace('&amp;', '&')
    //     b.setAttribute('href', url);
    //     b.setAttribute('style', 'color:rgb(119, 119, 119)')
    //     b.setAttribute('class', 'persist-link li-link')
    //     options[2].appendChild(b);

    //     var index = 3;
    //     for (var i = 3; i < options.length; i++) {
    //         if ((index - 2) % 4 == 0) {
    //             index = 3;
    //         }
    //         var b = document.createElement("a");
    //         b.textContent = `Show ${(index - 2) * 3}`;
    //         options[i].innerHTML = "";
    //         var url = "{{url_for('shop_api.shop', order=request.args.get('order'))}}".replace('&amp;', '&')
    //         url += `?&per_page=${(index - 2) * 3}`;
    //         console.log(url);
    //         url = url.replace(/(\?[^\?]*)\?/g, '$1');
    //         console.log(url);
    //         b.setAttribute('href', url);
    //         b.setAttribute('style', 'color:rgb(119, 119, 119)')
    //         b.setAttribute('class', 'persist-link li-link')
    //         // b.onclick(() => {
    //         //     window.location.href = 'newPage.html';
    //         // });
    //         options[i].appendChild(b);
    //         index++;
    //     }

    //     $('li.option').addClass('options');

    // });
</script>
<!-- End related-product Area -->
{% endblock content %}